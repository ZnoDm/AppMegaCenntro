<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorate="layout">
<head>
    <title>Nueva Nota Entrada </title>
    <th:block layout:fragment="styles">
    <link rel="stylesheet" th:href="@{/admin/static/css/switch.css}">
    <link rel="stylesheet" th:href="@{/admin/static/css/jquery-ui.min.css}">
    </th:block>
</head>
<body>
	<!-- CONTENIDO -->
	<div layout:fragment="content">
		<div class="card">
			<div class="card-header"> <h3>Nota Entrada</h3></div>
			<div class="card-body">
				<form th:action="@{/notaentrada/save}" th:object="${notaentrada}" method="post" class="form-horizontal">
                    <div class="box-body row">
                    	<div class="form-group col-12">
                    		<h5>Trabajador</h5>
                    	</div>
                    	<input type="hidden" th:field="*{trabajador.id}" readonly/>
                    	<div class="form-group col-12 col-lg-6">
                            <label class="control-label">Nombres</label>
                            <div>
                                <input type="text" class="form-control" th:field="*{trabajador.nombres}" readonly/>
                            </div>
                        </div>
                        <div class="form-group col-12 col-lg-6">
                            <label class="control-label">Apellidos</label>
                            <div>
                                <input type="text" class="form-control" th:field="*{trabajador.apellidos}" readonly/>
                            </div>
                        </div>
                        <div class="form-group col-12"><hr></div>
                        
                        
                        <div class="form-group col-12">
                    		<h5>Proveedor</h5>
                    	</div>
                    	<input type="hidden" th:field="*{proveedor.id}" readonly/>
                   	 	<div class="form-group col-7 col-lg-3">
                           <label for="buscar_proveedor" class="col-form-label" th:text="'Buscar proveedor'"></label>
							<input type="text" name="buscar_proveedor" id="buscar_proveedor" class="form-control" />
                       	</div>

                    	<div class="form-group col-12 col-lg-6">
                            <label class="control-label">Nombres</label>
                            <div>
                                <input type="text" class="form-control" th:field="*{proveedor.nombres}" readonly/>
                            </div>
                        </div>
                        <div class="form-group col-12 col-lg-3">
                            <label class="control-label">Tipo Documento</label>
                            <div>
                                <input type="text" class="form-control" th:field="*{proveedor.tipoDocumentoIdentidad}" readonly/>
                            </div>
                        </div>
                        <div class="form-group col-12 col-lg-3">
                            <label class="control-label">Documento Identidad</label>
                            <input type="text" class="form-control" th:field="*{proveedor.documentoIdentidad}" readonly/>
                        </div>
                        <div class="form-group col-12"><hr></div>
                       	<div class="form-group col-12">
                    		<h5>Detalle de Nota Entrada</h5>
                    	</div>
                    	<div class="form-group col-12 col-lg-3">
                            <label class="control-label">Tipo Documento</label>
                            <select class="form-select form-control" id="tipoDocumento" name="tipoDocumento">
                                <option value="FACTURA">FACTURA</option>
                            </select>
                        </div>
                    	<div class="form-group col-12 col-lg-5">
                            <label for="buscar_producto" class="col-form-label"
							th:text="'Buscar producto'"></label>
							<input type="text" name="buscar_producto" id="buscar_producto"
								class="form-control" />
                        </div>
                        <div class="form-group col-12">
                        	<table class="d-none">

								<tbody id="plantillaItemsFactura">
									<tr id="row_{ID}">
										<td class="d-none"><input type="hidden" value="{ID}"
											name="item_id[]" /></td>
										<td>{NOMBRE}</td>
										<td><input type="number" value="1" name="cantidad[]"
											id="cantidad_{ID}" class="form-control col-sm-4"/></td>

										<td><a href="#" class="btn btn-danger btn-sm" onclick="itemsHelper.eliminarLineaFactura({ID});">
											<i class="material-icons md-18">
												delete
												</i>
										</a></td>
									</tr>
						
								</tbody>
						
							</table>

							<table id="cargarItemProductos"
							class="table table-sm table-striped table-hover">
								<thead>
									<tr>
										<th>Nombre</th>
										<th>Cantidad</th>
										<th>Eliminar</th>
									</tr>
								</thead>
								<tbody>
								</tbody>
							</table>
                        </div>
                    </div>
                    <hr>
	                 <!-- /.box-body -->
	                 <div class="box-footer center">
	                     <a th:href="@{/notaentrada/listar}">
	                         <button type="button" class="btn btn-default"><i class="fa fa-right"></i> Cancel</button>
	                     </a>
	                     <button type="submit" class="btn btn-info pull-right"><i class="fa fa-save"></i> Save</button>
	                 </div>
	                 <!-- /.box-footer -->
                </form>
                
			</div>
		</div>						

	</div>
	
	<th:block layout:fragment="script">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>

    <script>
    	
    	var mensajeError = "[[${mensajeError}]]";
			if(mensajeError){
		    	Swal.fire({
		    		position: 'center',
		            icon: 'error',
		            title: 'Error...',
		            showConfirmButton: false,
		            text: mensajeError,
		            timer: 1500
			  	})
		  	}
		  	
			$("#buscar_producto").autocomplete({

				source : function(request, response) {
					$.ajax({
						url : "/producto/cargar-productos/" + request.term,
						dataType : "json",
						data : {
							term : request.term
						},
						success : function(data) {
							response($.map(data, function(item) {
								return {
									value : item.id,
									label : item.nombreProducto,
									precio : item.precioUnitario,
								};
							}));
						},
					});
				},
				select : function(event, ui) {
					//$("#buscar_producto").val(ui.item.label);

					if(itemsHelper.hasProducto(ui.item.value)){
						itemsHelper.incrementaCantidad(ui.item.value, ui.item.precio);
						return false;
					}
					
					var linea = $("#plantillaItemsFactura").html();

					linea = linea.replace(/{ID}/g, ui.item.value);
					linea = linea.replace(/{NOMBRE}/g, ui.item.label);

					$("#cargarItemProductos tbody").append(linea);

					return false;
				}
			});
		
			var itemsHelper = {
				hasProducto: function(id){
					
					var resultado = false;
					
					$('input[name="item_id[]"]').each(function(){
						if(parseInt(id) == parseInt($(this).val()) ){
							resultado = true;
						}
					});
					
					return resultado;
				},
				incrementaCantidad: function(id, precio){
					var cantidad = $("#cantidad_" + id).val() ? parseInt($("#cantidad_" + id).val()) : 0;
					$("#cantidad_" + id).val(++cantidad);
					this.calcularImporte(id, precio, cantidad);
				},
				eliminarLineaFactura: function(id){
					$("#row_" + id).remove();
				},
			}
			$("#buscar_proveedor").autocomplete({
				source : function(request, response) {
					$.ajax({
						url : "/proveedor/cargar-proveedores/" + request.term,
						dataType : "json",
						data : {
							term : request.term
						},
						success : function(data) {
							response($.map(data, function(item) {
								return {
									value : item,
									label : item.nombres,
									id : item.id,
									tipoDocumentoIdentidad : item.tipoDocumentoIdentidad,
									documentoIdentidad : item.documentoIdentidad,
								};
							}));
						},
					});
				},
				select : function(event, ui) {
					console.log(ui.item.id);
					$("#proveedor\\.id").val(ui.item.id);
				    $("#proveedor\\.tipoDocumentoIdentidad").val(ui.item.tipoDocumentoIdentidad);
				    $("#proveedor\\.documentoIdentidad").val(ui.item.documentoIdentidad);
				    $("#proveedor\\.nombres").val(ui.item.label);
				    return false;
				}
			});
    </script>
</th:block>

</body>				
	   
</html>
	 
	 
	 